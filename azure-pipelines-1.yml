trigger:
- main

variables:
  buildConfiguration: 'Release'
  publishDir: '$(Build.ArtifactStagingDirectory)/publish'
  iisPath: 'C:\inetpub\AspNetCoreAPI'
  appPoolName: 'AspNetCoreAPI'

stages:

# =========================
# STAGE 1: BUILD & PUBLISH
# =========================
- stage: Build
  displayName: 'Build & Publish ASP.NET Core API'
  jobs:
  - job: BuildJob
    displayName: 'Build Job'
    pool:
      vmImage: 'windows-latest'

    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet Packages'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'

    - task: DotNetCoreCLI@2
      displayName: 'Build Solution'
      inputs:
        command: 'build'
        arguments: '--configuration $(buildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: 'Publish API'
      inputs:
        command: 'publish'
        arguments: '--configuration $(buildConfiguration) --output $(publishDir)'
        publishWebProjects: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact'
      inputs:
        pathToPublish: '$(publishDir)'
        artifactName: 'drop'


# =========================
# STAGE 2: DEPLOY TO IIS
# =========================
- stage: Deploy
  displayName: 'Deploy to Local IIS'
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: 'Deploy Job'
    pool:
      name: 'DemoPool'   # ðŸ‘ˆ self-hosted agent

    steps:
    - download: current
      artifact: drop
      displayName: 'Download Build Artifact'

    - task: PowerShell@2
      displayName: 'Stop IIS App Pool'
      inputs:
        targetType: 'inline'
        script: |
          Import-Module WebAdministration
          Stop-WebAppPool -Name "$(appPoolName)"

    - task: CopyFiles@2
      displayName: 'Deploy Files to IIS'
      inputs:
        SourceFolder: '$(Pipeline.Workspace)/drop'
        Contents: '**'
        TargetFolder: '$(iisPath)'
        OverWrite: true

    - task: PowerShell@2
      displayName: 'Start IIS App Pool'
      inputs:
        targetType: 'inline'
        script: |
          Import-Module WebAdministration
          Start-WebAppPool -Name "$(appPoolName)"
